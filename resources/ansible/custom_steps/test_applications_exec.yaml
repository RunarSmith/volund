---

# parameters:
#   default_username: the user to run the commands as, default is 'volund'
#   test_commands: a list of commands to test if the applications are installed
#
# - name: execute test commands
#   include_tasks: "{{ role_path }}/../../custom_steps/test_applications_exec.yaml"
#   vars:
#     commands_list: "{{ test_commands }}"
#     username: "{{ default_username }}"
#

# --- applications ----------------------------------------

- name: "Check commands execution"
  ansible.builtin.command: "{{ item }}"
  register: app_check
  ignore_errors: true
  loop: "{{ commands_list }}"
  loop_control:
    loop_var: item
  become: true
  become_user: "{{ default_username }}"

# - name: "Display the output of each command"
#   ansible.builtin.debug:
#     msg: |
#       Command: {{ item.item }}
#       Stdout: {{ item.stdout }}
#       Stderr: {{ item.stderr }}
#   loop: "{{ app_check.results }}"

- name: "Assert all required applications are installed"
  ansible.builtin.assert:
    that:
      - "app_check.results | selectattr('rc', 'eq', 0) | list | length == test_commands | length"
    fail_msg: "One or more required applications are missing or not executable."
